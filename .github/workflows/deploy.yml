name: CD - Deploy to Production

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: '20'

jobs:
  # ====================================
  # Deploy Backend
  # ====================================
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: backend
        run: npm ci --production

      - name: Generate Prisma Client
        working-directory: backend
        run: npx prisma generate

      - name: Build
        working-directory: backend
        run: npm run build

      - name: Create deployment package
        run: |
          cd backend
          tar -czf ../deploy-package.tar.gz \
            dist/ \
            prisma/ \
            package.json \
            package-lock.json \
            node_modules/

      - name: Copy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: deploy-package.tar.gz
          target: /tmp/pairlive-deploy/

      - name: Deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e

            DEPLOY_DIR="/var/www/pairlive/backend"
            BACKUP_DIR="/var/www/pairlive/backups/$(date +%Y%m%d_%H%M%S)"

            echo "üì¶ Creating backup..."
            mkdir -p "$BACKUP_DIR"
            cp -r "$DEPLOY_DIR/dist" "$BACKUP_DIR/" 2>/dev/null || true

            echo "üöÄ Deploying new version..."
            cd /tmp/pairlive-deploy
            tar -xzf deploy-package.tar.gz -C "$DEPLOY_DIR"

            echo "üóÑÔ∏è Running database migrations..."
            cd "$DEPLOY_DIR"
            npx prisma migrate deploy 2>/dev/null || npx prisma db push --accept-data-loss

            echo "‚ôªÔ∏è Restarting application..."
            pm2 restart pairlive-api || pm2 start dist/server.js --name pairlive-api

            echo "üè• Health check..."
            sleep 5
            curl -f http://localhost:3000/health || {
              echo "‚ùå Health check failed! Rolling back..."
              cp -r "$BACKUP_DIR/dist" "$DEPLOY_DIR/"
              pm2 restart pairlive-api
              exit 1
            }

            echo "üßπ Cleanup..."
            rm -rf /tmp/pairlive-deploy

            echo "‚úÖ Deployment successful!"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment to ${{ github.event.inputs.environment || 'production' }} successful"
          else
            echo "‚ùå Deployment to ${{ github.event.inputs.environment || 'production' }} failed"
          fi

  # ====================================
  # Post-deploy verification
  # ====================================
  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-backend]

    steps:
      - name: Health check
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 10

          # Health check
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            https://${{ secrets.API_DOMAIN }}/health || echo "000")

          if [ "$STATUS" == "200" ]; then
            echo "‚úÖ API is healthy (HTTP $STATUS)"
          else
            echo "‚ö†Ô∏è API health check returned HTTP $STATUS"
            exit 1
          fi

      - name: Detailed health check
        run: |
          curl -s https://${{ secrets.API_DOMAIN }}/health/detailed | jq .
        continue-on-error: true
