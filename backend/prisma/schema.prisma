// ============================================
// PAIRLIVE Database Schema
// Skema database menggunakan Prisma ORM
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// PENGGUNA & AUTENTIKASI
// ===========================================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  displayName  String   @map("display_name")
  photoUrl     String?  @map("photo_url")
  bio          String?
  interests    String[] @default([])
  gender       String
  birthDate    DateTime @map("birth_date")
  
  // Trust & Reputasi
  trustScore    Int     @default(50) @map("trust_score")      // Skor kepercayaan 0-100
  trustCategory String  @default("GOOD") @map("trust_category") // PREMIUM/GOOD/WARNING/RESTRICTED/SUSPENDED
  level         Int     @default(1)                            // Level pengguna
  
  // Ekonomi Koin
  coinBalance     Int @default(0) @map("coin_balance")         // Saldo koin saat ini
  totalCoinsEarned Int @default(0) @map("total_coins_earned") // Total koin yang pernah didapat
  totalCoinsSpent  Int @default(0) @map("total_coins_spent")  // Total koin yang pernah dihabiskan
  
  // Statistik
  totalSessions Int   @default(0) @map("total_sessions")      // Total sesi yang diikuti
  totalMinutes  Int   @default(0) @map("total_minutes")       // Total menit livestream
  averageRating Float @default(0) @map("average_rating")      // Rating rata-rata
  
  // Status Premium
  isPremium       Boolean   @default(false) @map("is_premium")
  premiumUntil    DateTime? @map("premium_until")
  
  // Reset Password
  passwordResetToken  String?   @map("password_reset_token")
  passwordResetExpiry DateTime? @map("password_reset_expiry")
  
  // Timestamp
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  lastLoginAt  DateTime? @map("last_login_at")
  deletedAt    DateTime? @map("deleted_at")
  
  // Relasi
  sessionsAsUser1   Session[]       @relation("SessionUser1")
  sessionsAsUser2   Session[]       @relation("SessionUser2")
  feedbacksGiven    Feedback[]      @relation("FeedbackReviewer")
  feedbacksReceived Feedback[]      @relation("FeedbackTarget")
  giftsSent         Gift[]          @relation("GiftSender")
  giftsReceived     Gift[]          @relation("GiftReceiver")
  friendships1      Friendship[]    @relation("FriendshipUser1")
  friendships2      Friendship[]    @relation("FriendshipUser2")
  friendRequestsSent     FriendRequest[] @relation("FriendRequestSender")
  friendRequestsReceived FriendRequest[] @relation("FriendRequestReceiver")
  reportsMade       Report[]        @relation("ReportReporter")
  reportsReceived   Report[]        @relation("ReportReported")
  behaviors         UserBehavior[]
  purchases         Purchase[]
  
  @@index([email])
  @@index([trustScore])
  @@index([trustCategory])
  @@map("users")
}

// ===========================================
// SESI LIVESTREAM
// ===========================================

model Session {
  id             String   @id @default(uuid())
  user1Id        String   @map("user1_id")
  user2Id        String   @map("user2_id")
  agoraChannelId String   @map("agora_channel_id")
  
  status    String   @default("ACTIVE") // ACTIVE, COMPLETED, SKIPPED, DISCONNECTED
  startTime DateTime @map("start_time")
  endTime   DateTime? @map("end_time")
  duration  Int?     // Durasi dalam detik
  endedBy   String?  @map("ended_by") // ID pengguna yang mengakhiri sesi
  
  // Relasi
  user1     User       @relation("SessionUser1", fields: [user1Id], references: [id])
  user2     User       @relation("SessionUser2", fields: [user2Id], references: [id])
  feedbacks Feedback[]
  gifts     Gift[]
  reports   Report[]
  behaviors UserBehavior[]
  
  @@index([user1Id])
  @@index([user2Id])
  @@index([status])
  @@index([startTime])
  @@map("sessions")
}

// ===========================================
// FEEDBACK & RATING
// ===========================================

model Feedback {
  id           String   @id @default(uuid())
  sessionId    String   @map("session_id")
  reviewerId   String   @map("reviewer_id")    // Pengguna yang memberi rating
  targetUserId String   @map("target_user_id") // Pengguna yang diberi rating
  rating       Int      // Rating 1-5 bintang
  comment      String?  // Komentar opsional
  createdAt    DateTime @default(now()) @map("created_at")
  
  // Relasi
  session Session @relation(fields: [sessionId], references: [id])
  reviewer User   @relation("FeedbackReviewer", fields: [reviewerId], references: [id])
  target   User   @relation("FeedbackTarget", fields: [targetUserId], references: [id])
  
  @@unique([sessionId, reviewerId])
  @@index([targetUserId])
  @@map("feedbacks")
}

// ===========================================
// EKONOMI KOIN & HADIAH
// ===========================================

model Gift {
  id            String   @id @default(uuid())
  sessionId     String   @map("session_id")
  senderId      String   @map("sender_id")
  receiverId    String   @map("receiver_id")
  giftType      String   @map("gift_type")      // Jenis hadiah: heart, star, flower, crown, diamond
  coinAmount    Int      @map("coin_amount")    // Jumlah koin
  receiverAmount Int     @map("receiver_amount") // Jumlah setelah potongan platform (70%)
  createdAt     DateTime @default(now()) @map("created_at")
  
  // Relasi
  session  Session @relation(fields: [sessionId], references: [id])
  sender   User    @relation("GiftSender", fields: [senderId], references: [id])
  receiver User    @relation("GiftReceiver", fields: [receiverId], references: [id])
  
  @@index([sessionId])
  @@index([senderId])
  @@index([receiverId])
  @@map("gifts")
}

model CoinTransaction {
  id          String   @id @default(uuid())
  senderId    String?  @map("sender_id")
  receiverId  String?  @map("receiver_id")
  type        String   // PURCHASE, GIFT, BONUS, WITHDRAWAL
  amount      Int      // Jumlah koin
  description String?  // Deskripsi transaksi
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@index([senderId])
  @@index([receiverId])
  @@index([type])
  @@map("coin_transactions")
}

model Purchase {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  packageId String   @map("package_id")  // ID paket koin
  coins     Int      // Jumlah koin yang dibeli
  amount    Float    // Harga dalam USD
  currency  String   @default("USD")
  platform  String   // ios, android
  receipt   String   @unique // Receipt dari App Store/Play Store
  status    String   @default("COMPLETED") // PENDING, COMPLETED, REFUNDED
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relasi
  user User @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@map("purchases")
}

// ===========================================
// PERTEMANAN
// ===========================================

model Friendship {
  id        String   @id @default(uuid())
  userId1   String   @map("user1_id")
  userId2   String   @map("user2_id")
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relasi
  user1 User @relation("FriendshipUser1", fields: [userId1], references: [id])
  user2 User @relation("FriendshipUser2", fields: [userId2], references: [id])
  
  @@unique([userId1, userId2])
  @@index([userId1])
  @@index([userId2])
  @@map("friendships")
}

model FriendRequest {
  id         String   @id @default(uuid())
  senderId   String   @map("sender_id")
  receiverId String   @map("receiver_id")
  status     String   @default("PENDING") // PENDING, ACCEPTED, REJECTED
  createdAt  DateTime @default(now()) @map("created_at")
  
  // Relasi
  sender   User @relation("FriendRequestSender", fields: [senderId], references: [id])
  receiver User @relation("FriendRequestReceiver", fields: [receiverId], references: [id])
  
  @@index([senderId])
  @@index([receiverId])
  @@index([status])
  @@map("friend_requests")
}

// ===========================================
// LAPORAN & MODERASI
// ===========================================

model Report {
  id             String   @id @default(uuid())
  sessionId      String   @map("session_id")
  reporterId     String   @map("reporter_id")      // Pengguna yang melapor
  reportedUserId String   @map("reported_user_id") // Pengguna yang dilaporkan
  reason         String   // Alasan laporan
  description    String?  // Deskripsi detail
  status         String   @default("PENDING") // PENDING, RESOLVED, DISMISSED
  reviewedBy     String?  @map("reviewed_by")      // Admin yang review
  reviewedAt     DateTime? @map("reviewed_at")
  createdAt      DateTime @default(now()) @map("created_at")
  
  // Relasi
  session      Session @relation(fields: [sessionId], references: [id])
  reporter     User    @relation("ReportReporter", fields: [reporterId], references: [id])
  reportedUser User    @relation("ReportReported", fields: [reportedUserId], references: [id])
  
  @@index([reportedUserId])
  @@index([status])
  @@map("reports")
}

// ===========================================
// PELACAKAN PERILAKU PENGGUNA
// ===========================================

model UserBehavior {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  sessionId    String?  @map("session_id")
  behaviorType String   @map("behavior_type") // SKIP, AFK, LONG_SESSION, dll.
  metadata     Json?    // Data tambahan dalam format JSON
  createdAt    DateTime @default(now()) @map("created_at")
  
  // Relasi
  user    User     @relation(fields: [userId], references: [id])
  session Session? @relation(fields: [sessionId], references: [id])
  
  @@index([userId])
  @@index([behaviorType])
  @@index([createdAt])
  @@map("user_behaviors")
}
